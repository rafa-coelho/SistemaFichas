<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rolagem</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-giJF6kkoqNQ00vy+HMDP7azOuL0xtbfIcaT9wjKHr8RbDVddVHyTfAAsrekwKmP1" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta1/dist/js/bootstrap.bundle.min.js" integrity="sha384-ygbV9kiqUc6oa4msXn9868pTtWMgiQaeYH7/t7LECLbyPA2x65Kgf80OJFdroafW" crossorigin="anonymous"></script>
    <link rel="preconnect" href="https://fonts.gstatic.com">
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">

    <style>
        *{
            font-family: 'Roboto', sans-serif;
        }
        .gold {
            color: #000;
            font-weight: bold;
            text-shadow: 0px 0px 8px gold;
        }
    </style>
</head>
<body>

    <div class="container-fluid" id="rolagem" style="height: 100vh; display: none;" >
        <div class="col-md-12 text-center" style="height: 70px">
            <img src="/media/d20.png" alt="D20" height="70" class="img-responsive">
            <h3 style="position: relative; margin-top: -47px;" class="gold" id="valor_rolagem">20</h3>
        </div>
        <div class="col-md-12 text-center" style="height: 30px;">
            <h4 id="resultado" class="gold">
                Sucesso!
            </h4>
        </div>
    </div>

</body>
</html>

<style>

</style>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
    const urlParams = new URLSearchParams(window.location.search);
    const personagem = urlParams.get('personagem');

    const SecondsAgo = (num) => {
        var date = new Date();
        date.setHours(date.getHours(), date.getMinutes(), date.getSeconds() - num, date.getMilliseconds());
        return (date.getTime() / 1000) | 0;
    };

    
    const checkRoll = () => {
        timestamp = SecondsAgo(5);
        $.ajax({
            url: `/rolagem/personagem/${personagem}?timestamp=${timestamp}`,
            method: 'GET',
            complete: (res) => {
                const response = res.responseJSON;
                console.log(response.data);
                if(response.status === 1){
                    for (let i = 0; i < response.data.rolagens.length; i++) {
                        const rolagem = response.data.rolagens[i];

                        $("#valor_rolagem").text(rolagem.valor);
                        $("#resultado").text(rolagem.tipo);
                        $("#rolagem").fadeIn('slow');
                        setTimeout(() => {
                            $('#rolagem').fadeOut('slow');
                        }, 3000);

                    }

                    setTimeout(() => {
                        checkRoll();
                    }, 5000);

                }else{
                    setTimeout(() => {
                        checkRoll();
                    }, 5000);
                }

            }
        });
    };

    $(() => {
        checkRoll();
    });




    
    
</script>